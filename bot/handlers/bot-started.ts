import { Context, Keyboard } from '@maxhub/max-bot-api';
import { upsertUser, clearLastMotivationalMessage } from '../../db/db-user-utils.ts';

/**
 * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞.
 * 
 * –î–æ–±–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö, –µ—Å–ª–∏ –µ–≥–æ –µ—â—ë –Ω–µ—Ç,
 * –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.
 * 
 * @param ctx - –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å–æ–±—ã—Ç–∏—è
 */
export async function botStartedHandler(ctx: Context) {
  const user = ctx.user;
  if (!user) return;

  await upsertUser(user.user_id, user.name);
  
  // –û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏, —Ç–∞–∫ –∫–∞–∫ –¥–∏–∞–ª–æ–≥ –Ω–∞—á–∞—Ç –∑–∞–Ω–æ–≤–æ
  // –∏ —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ–ª—å—à–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
  await clearLastMotivationalMessage(user.user_id);

  const siteUrl = process.env.WEB_APP_URL;
  const isLocalhost = siteUrl && (siteUrl.includes('localhost') || siteUrl.includes('127.0.0.1') || siteUrl.includes('0.0.0.0'));
  
  if (!siteUrl) {
    console.warn('‚ö†Ô∏è –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è WEB_APP_URL –Ω–µ –∑–∞–¥–∞–Ω–∞. –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å–æ —Å—Å—ã–ª–∫–æ–π –Ω–µ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞.');
  }

  const keyboardRows: Parameters<typeof Keyboard.inlineKeyboard>[0] = [];
  if (siteUrl && !isLocalhost) {
    keyboardRows.push([Keyboard.button.link('–û—Ç–∫—Ä—ã—Ç—å –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ', siteUrl)]);
  }
  keyboardRows.push([Keyboard.button.link('–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ VK –î–æ–±—Ä–æ', 'https://dobro.mail.ru/')]);

  const attachments = keyboardRows.length
    ? [Keyboard.inlineKeyboard(keyboardRows)]
    : undefined;

  const messageParts = [
    `üåü –ü—Ä–∏–≤–µ—Ç, ${user.name}! üëã\n\n–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ **–î–æ–±—Ä–∞—è –¥—É—à–∞** ‚Äî –ø–ª–∞—Ç—Ñ–æ—Ä–º—É –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –±–ª–∞–≥–æ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤!`,
    'üéØ **–ß—Ç–æ –≤—ã –º–æ–∂–µ—Ç–µ –¥–µ–ª–∞—Ç—å:**\n\nüì± **–ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã**\n‚Ä¢ –ò–∑—É—á–∞–π—Ç–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å –±–ª–∞–≥–æ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω—ã–º–∏ –ø—Ä–æ–µ–∫—Ç–∞–º–∏\n‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º\n‚Ä¢ –û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ —Å–≤–æ—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É\n\n‚ú® **–°–æ–∑–¥–∞–≤–∞—Ç—å —Å–≤–æ–∏ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã**\n‚Ä¢ –ü—É–±–ª–∏–∫—É–π—Ç–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã –ø–æ–º–æ—â–∏\n‚Ä¢ –í—ã–±–∏—Ä–∞–π—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é: ü´∂ –ë–ª–∞–≥–æ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, üå± –≠–∫–æ-–º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è, ü§ù –í–æ–ª–æ–Ω—Ç–µ—Ä—Å—Ç–≤–æ\n‚Ä¢ –£–ø—Ä–∞–≤–ª—è–π—Ç–µ —Å–≤–æ–∏–º–∏ –ø—Ä–æ–µ–∫—Ç–∞–º–∏ –≤ –ø—Ä–æ—Ñ–∏–ª–µ',
    'üí° **–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**\n\n–ö–∞–∂–¥—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã –ø—Ä–∏–±–ª–∏–∂–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—É—é –ø–æ–º–æ—â—å –ª—é–¥—è–º. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –≤–∞—à—É –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.',
    'ü§ù **–ë–æ–ª—å—à–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π:**\n\n–ò–∑—É—á–∞–π—Ç–µ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã, –æ—Ç–∫–ª–∏–∫–∞–π—Ç–µ—Å—å –Ω–∞ —Ç–µ, —á—Ç–æ –≤–∞–º –±–ª–∏–∑–∫–∏, –∏ –≤–º–µ—Å—Ç–µ –º—ã —Å–º–æ–∂–µ–º –æ–∫–∞–∑–∞—Ç—å —Ä–µ–∞–ª—å–Ω—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É!',
  ];

  if (siteUrl && isLocalhost) {
    messageParts.push(`\nüîó –ú–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: ${siteUrl}`);
  }

  await ctx.reply(
    messageParts.join('\n\n'),
    attachments
      ? {
          attachments,
        }
      : undefined,
  );
  console.log('‚ÑπÔ∏è bot-started —Å–æ–±—ã—Ç–∏–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', user.user_id);
}
